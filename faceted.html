<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Elasticsearch + Angular Example</title>
    <link href="bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom styles for this template -->
    <link href="offcanvas.css" rel="stylesheet">
</head>
<body ng-app="ExampleApp">
  
  <!-- overall container and controller -->
  <div ng-controller="ExampleController as exctl">
    
    <!-- navbar search box -->
    <nav class="navbar navbar-fixed-top navbar-inverse" role="navigation">
        <div class="container">
        <form ng-submit="exctl.search()" class="navbar-form navbar-left" role="search">
            <div class="form-group">
              <input type="text" ng-model="exctl.queryTerm" class="form-control" placeholder="Search">
            </div>
            <button type="submit" class="btn btn-default">Search</button>
        </form>
        </div>
    </nav>
    
    <!-- main content container -->
    <div class="container">
       <div class="row row-offcanvas row-offcanvas-right">
            
            <!-- search results -->
            <div class="col-xs-12 col-sm-9">
                
                <!-- error -->
                <div ng-if="exctl.error" class="alert alert-danger" role="alert">{{exctl.error.message}}</div>
                
                <!-- hits -->
                <div ng-repeat="doc in exctl.results.hits.hits">
                    <div><strong>{{doc._source.year}}</strong> &middot; <em>{{doc._source.name}}</em></div> 
                        <p>
                            <span ng-repeat="snip in doc.highlight.content">
                                <span ng-bind-html="snip"></span><br />
                            </span>
                        </p>
                    </div>
                </div>
                
            </div> 

                <!-- subject tags -->
<!-- 
                <ul class="nav nav-pills nav-stacked" style="max-width: 200px;" ng-repeat="entry in exctl.results.facets.tags.terms">
                    <li ng-class="exctl.isActive('subject_tags', entry.term)">
                    <a ng-click="exctl.filter('subject_tags', entry.term)">
                        {{ entry.term }} 
                        <span class="badge pull-right">{{ entry.count }}</span>
                    </a>
                    </li>
                </ul>
 -->
                
            <!-- facets -->
            <div class="col-xs-6 col-sm-3 sidebar-offcanvas" id="sidebar" role="navigation">
                
                <!-- subject tags -->
                <div class="list-group">
                    <a href="#" class="list-group-item" 
                                   ng-class="exctl.isActive('subject_tags', entry.term)"
                                   ng-click="exctl.filter('subject_tags', entry.term)"
                                   ng-repeat="entry in exctl.results.facets.tags.terms">
                        {{ entry.term }} <span class="badge pull-right">{{ entry.count }}</span>
                    </a>
                </div>

                <!-- court name -->
<!-- 
                <ul class="nav nav-pills nav-stacked" style="max-width: 200px;" ng-repeat="entry in exctl.results.facets.courts.terms">
                    <li ng-class="exctl.isActive('court', entry.term)">
                    <a ng-click="exctl.filter('court', entry.term)">
                        {{ entry.term }} 
                        <span class="badge pull-right">{{ entry.count }}</span>
                    </a>
                    </li>
                </ul>
                
                <!~~ ip case type tag ~~>
                <ul class="nav nav-pills nav-stacked" style="max-width: 200px;" ng-repeat="entry in exctl.results.facets.ip_category.terms">
                    <li ng-class="exctl.isActive('tags', entry.term)">
                    <a ng-click="exctl.filter('tags', entry.term)">
                        {{ entry.term }} 
                        <span class="badge pull-right">{{ entry.count }}</span>
                    </a>
                    </li>
                </ul>
 -->
                
            </div> 
            
        </div> <!-- main container row -->

    </div> <!-- main content container -->


  </div> <!-- controller -->

  <!-- include bower components in proper order -->
  <script src="bower_components/angular/angular.js"></script>
  <script src="bower_components/angular-sanitize/angular-sanitize.js"></script>
  <script src="bower_components/elastic.js/dist/elastic.js"></script>
  <script src="bower_components/elasticsearch/elasticsearch.angular.js"></script>

  <!-- app code starts is here -->
  <script>
    
    // App module
    var ExampleApp = angular.module('ExampleApp', ['elasticsearch', 'ngSanitize']);

    // Service – esFactory() creates a configured client instance. Turn that instance
    // into a service so that it can be required by other parts of the application
    ExampleApp.service('client', function (esFactory) {
      return esFactory({
        host: 'localhost:9200',
        apiVersion: '1.2',
        log: 'trace'
      });
    });

    // Controller – requires the "client" service, and fetches information about the server,
    //   it adds either an error or info about the server to $scope. It also requires the esFactory
    //   to that it can check for a specific type of error which might come back from the client
    ExampleApp.controller('ExampleController', ['client', 'esFactory', function (client, esFactory) {

        var self = this;
        self.queryTerm = 'piracy';
        var sf = ejs.TermsFacet('tags').field('subject_tags').size(10);
        var cf = ejs.TermsFacet('courts').field('court').size(10);
        var tf = ejs.TermsFacet('ip_category').field('tags').size(10);
        var hl = ejs.Highlight('content').fragmentSize(80).numberOfFragments(100).encoder('html').preTags('<strong>').postTags('</strong>');

        self.search = function() {
            client.search({
              index: 'fashion_test',
              type: 'case',
              body: ejs.Request().facet(cf).facet(sf).facet(tf).query(applyFilters(ejs.MatchQuery('content', self.queryTerm))).size(100).highlight(hl).sort('year')
            }).then(function (resp) {
                    console.log(resp);
                    self.results = resp;
                 }, 
                 function (err) {
                    self.error = err;

                    // if the err is a NoConnections error, then the client was not able to
                    // connect to elasticsearch. In that case, create a more detailed error message
                    if (err instanceof esFactory.errors.NoConnections) {
                      self.error = new Error('Unable to connect to elasticsearch. ' +
                        'Make sure that it is running and listening at http://localhost:9200');
                    }
                 });
        };
        
        var activeFilters = {};

        self.isActive = function (field, term) {
            return activeFilters.hasOwnProperty(field + term) ? 'active' : '';
        };

        self.filter = function(field, term) {
            if (self.isActive(field, term)) {
                delete activeFilters[field + term];
            } else {
                activeFilters[field + term] = ejs.TermFilter(field, term);
            }
            self.search();
        }

        var applyFilters = function(query) {
    
            var filter = null;
            var filters = Object.keys(activeFilters).map(function(k) { return activeFilters[k]; });

            if (filters.length > 1) {
                filter = ejs.AndFilter(filters);
            } else if (filters.length === 1) {
                filter = filters[0];
            }

            return filter ? ejs.FilteredQuery(query, filter) : query;
        };

    }]);
  </script>
</body>
</html>